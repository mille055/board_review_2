server {
  listen 8080;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # Basic headers
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy no-referrer-when-downgrade always;

  # CORS (ok to keep permissive; tighten later if needed)
  add_header Access-Control-Allow-Origin * always;
  add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
  add_header Access-Control-Allow-Headers "Range, If-Range, Origin, Content-Type, Accept, Authorization, X-API-KEY, x-api-key" always;

  # Gzip for text assets
  gzip on;
  gzip_types text/plain text/css application/javascript application/json image/svg+xml;
  gzip_min_length 1024;

  # Frontend routing (SPA-friendly)
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Correct MIME for video
  types {
    video/mp4 mp4;
    video/webm webm;
    video/ogg ogv;
  }

  # Media: long cache
  location ~* \.(?:mp4|webm|ogg|ogv|jpg|jpeg|png|gif|svg)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }

  # JS/CSS: moderate cache
  location ~* \.(?:js|css)$ {
    add_header Cache-Control "public, max-age=604800";
    try_files $uri =404;
  }

  # index.html: no cache, so deploys take effect
  location = /index.html {
    add_header Cache-Control "no-store";
  }

  # Health endpoint for container/orchestrator
  location = /healthz {
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  # Proxy API â†’ FastAPI (Uvicorn) on :9000
  location /api/ {
    proxy_pass              http://127.0.0.1:9000;
    proxy_http_version      1.1;
    proxy_set_header        Host              $host;
    proxy_set_header        X-Real-IP         $remote_addr;
    proxy_set_header        X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme;
  }
}
